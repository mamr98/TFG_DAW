server {
    listen 80; # Esta línea será reemplazada por el script de entrada con el valor de PORT
    listen [::]:80; # Para IPv6, también será reemplazada
    server_name _;

    # **¡Importante! La raíz del documento principal es la carpeta 'public' de Laravel,**
    # **que contendrá tu index.html de React y los assets.**
    root /var/www/html/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.html index.htm index.php; # Primero busca index.html

    charset utf-8;

    # **Manejo de rutas para React y la API de Laravel:**
    # 1. Intenta servir el archivo directamente ($uri)
    # 2. Si es un directorio, intenta servir un index ($uri/)
    # 3. Si no encuentra nada, pasa a /index.php para que Laravel (la API) o React (via index.html) lo manejen
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # **Bloque específico para pasar las solicitudes PHP a PHP-FPM:**
    # Esto es para tus rutas de API de Laravel (ej. /api/users, /login, etc.)
    # Asegúrate de que tus rutas de API en Laravel no colisionen con archivos estáticos de React.
    location ~ \.php$ {
        # Siempre intenta servir el archivo PHP si existe, si no, devuelve 404 (seguridad)
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass 127.0.0.1:9000; # PHP-FPM está escuchando en este puerto dentro del contenedor
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # Bloques para archivos estáticos (CSS, JS, imágenes, etc.) - generalmente ya cubiertos por 'location /'
    # Pero puedes optimizar el cacheo si es necesario.
    # location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp)$ {
    #     expires 30d;
    #     add_header Cache-Control "public, no-transform";
    # }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    # Deniega el acceso a archivos ocultos (como .env, .git)
    location ~ /\.(?!well-known).* {
        deny all;
    }

    # Opcional: Manejo de errores HTTP para que Laravel o tu SPA puedan mostrarlos
    # error_page 404 /index.php;
    # error_page 500 502 503 504 /50x.html;
    # location = /50x.html {
    #     root /usr/share/nginx/html;
    # }
}